<!DOCTYPE html>
<html lang="en">

<head>
    
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="HandheldFriendly" content="True" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<meta name="generator" content="Hugo 0.80.0" />


<link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
<link rel="manifest" href="/favicon/site.webmanifest">
<link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/favicon/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/favicon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


<title>KV Raft - 6.824 Lab3C - Roy&#39;s Repo</title>


<meta name="author" content="Roy Liang" />


<meta name="description" content="A minimal Hugo theme with nice theme color." />


<meta name="keywords" content="Distributed System" />


<meta property="og:title" content="KV Raft - 6.824 Lab3C" />
<meta name="twitter:title" content="KV Raft - 6.824 Lab3C" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lianglouise.github.io/post/6.824_lab3a/" /><meta property="og:description" content="This post is about part A of Lab3 of MIT 6.824, Distributed Systems. For previous two parts, please refer to the posts about the Lab 1 and 2 under the tag Distributed System. In this post, we are to build a fault tolerant key-value services on top of Raft." />
<meta name="twitter:description" content="This post is about part A of Lab3 of MIT 6.824, Distributed Systems. For previous two parts, please refer to the posts about the Lab 1 and 2 under the tag Distributed System. In this post, we are to build a fault tolerant key-value services on top of Raft." /><meta name="twitter:card" content="summary" /><meta property="article:published_time" content="2021-02-10T23:44:05-05:00" /><meta property="article:modified_time" content="2021-02-10T23:44:05-05:00" />


<style>
    @media (prefers-color-scheme: dark) {
        body[data-theme='auto'] img {
            filter: brightness(60%);
        }
    }

    body[data-theme='dark'] img {
        filter: brightness(60%);
    }
</style>



<link rel="stylesheet" href="https://lianglouise.github.io/assets/css/fuji.min.css" />





<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'G-BJCGN2DM5Q');
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BJCGN2DM5Q"></script>


</head>

<body data-theme="auto">
    <script data-cfasync="false">
  
  var fujiThemeData = localStorage.getItem('fuji_data-theme');
  
  if (!fujiThemeData) {
    localStorage.setItem('fuji_data-theme', 'auto');
  } else {
    
    if (fujiThemeData !== 'auto') {
      document.body.setAttribute('data-theme', fujiThemeData === 'dark' ? 'dark' : 'light');
    }
  }
</script>
    <header>
    <div class="container-lg clearfix">
        <div class="col-12 header">
            <a class="title-main" href="https://lianglouise.github.io/">Roy&#39;s Repo</a>
            
            <span class="title-sub">Share some thoughts</span>
            
        </div>
    </div>
</header>

    <main>
        <div class="container-lg clearfix">
            
            <div class="col-12 col-md-9 float-left content">
                
<article>
    
    <h2 class="post-item post-title">
        <a href="https://lianglouise.github.io/post/6.824_lab3a/">KV Raft - 6.824 Lab3C</a>
    </h2>
    <div class="post-item post-meta">
        <span><i class="iconfont icon-today-sharp"></i>&nbsp;2021-02-10</span><span><i class="iconfont icon-file-tray-sharp"></i>&nbsp;517 words</span><span><i class="iconfont icon-pricetags-sharp"></i>&nbsp;<a href="/tags/distributed-system">Distributed System</a>&nbsp;</span>

    </div>
    
    <div class="post-content markdown-body">
        <p>This post is about part A of Lab3 of <a href="https://pdos.csail.mit.edu/6.824/index.html" target="_blank">MIT 6.824</a>, Distributed Systems. For previous two parts, please refer to the posts about the Lab 1 and 2 under the tag <a href="/tags/distributed-system/">Distributed System</a>. In this post, we are to build a fault tolerant key-value services on top of <a href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf" target="_blank">Raft</a>.</p>
<h2 id="overview">Overview</h2>
<p>The functions we need to achieve are in fact very simple. It will need three functions:</p>
<ol>
<li><code>Put(key, value)</code>: Create a new key-value pair. Replace with the <code>vlaue</code> if the keys exists in the map;</li>
<li><code>Append(key, value)</code>: If the <code>key</code> exists in the map, append <code>value</code> to the end of old value. If not, do as what <code>Put()</code> does;</li>
<li><code>Get(key)</code>: Return the value if <code>key</code> exists in the map. Otherwise, return an empty string.</li>
</ol>
<p>If it&rsquo;s a singe server app, it won&rsquo;t take much time to implement. However, for fault tolerance, we will have to maintain multiple kv servers so that the service is available. Thus the real problem now is how to coordinate and synchronize the data between the servers through Raft.</p>
<p><img class="img-zoomable" src="/imgs/kvraft/kvraft.png" alt="kvraft" />
</p>
<p>As diagram illustrated above, we will have a server cluster, where raft service can see each other to do the election and log replications but the kv server can only communicate with its only Raft service in the cluster. Clients will randomly send requests to any kv servers. However, only the kv server whose raft is the leader will proceed the request and send back the data. All other kv servers will reject the request and ask the client to try other kv server.</p>
<h2 id="client">Client</h2>
<p>Let us begin with something easy first. The job of client is very simple, sending requests to one kv server, waiting for response. If timeout or receive any error, retry with other kv server.</p>
<p>As we will have multiple clients running parallelly, to make sure it&rsquo;s able to know which client sent the request. We will assign each client an ID generated by <code>nrand()</code>. And there is also a chance that the same request might be sent multiple times. To identify the duplicate requests, each request should have an ID generated by <code>nrand()</code>, so that kv server is able to recognize the duplicate requests.</p>
<p>Besides, to speed up the later requests, the client can cache the last seen leader ID (which is basically the index of server in <code>ck.servers</code>), so it doesn&rsquo;t have to try from the first server.</p>
<p>Thus we can define the client as below:</p>
<pre><code class="language-go">type Clerk struct {
	servers   []*labrpc.ClientEnd
	serverNum int
    
	clientId int64 // client's own uid
    
	lastLeaderId int // The leader id last heard
}
</code></pre>
<p>When clients need to send the <code>Get</code> or <code>PutAppend</code> request, we can have <code>Get</code> defined like below as an example:</p>
<pre><code class="language-go">// common.go
type GetArgs struct {
	MsgId    int64
	ClientId int64
	Key      string
}

type GetArgs struct {
	Key   string
	Value string
    Err   string
}

// client.go
func (ck *Clerk) Get(key string) string {
    var reply GetReply
	args := GetArgs{
		MsgId:    nrand(),
		ClientId: ck.clientId,
		Key:      key,
	}
    
    for {
        // Send RPC
        ok := ck.servers[leaderId].Call(&quot;KVServer.Get&quot;, &amp;args, &amp;reply)
       	// If timeout, retry
        
        // either return or retry based on reply.Err
    }
}
</code></pre>
    </div>
</article>


<div class="license markdown-body">
    <blockquote>
        <p>Unless otherwise noted, the content of this site is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"
               target="_blank">CC BY-NC-SA 4.0</a>.</p>
    </blockquote>
</div>



            </div>
            <aside class="col-12 col-md-3 float-left sidebar">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/gpg_email/">Email</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>Links</h3>
        <ul>
            
            <li>
                <a href="https://github.com/lianglouise" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/jiasong-liang" target="_blank"><span>Linkedin</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/tags/distributed-system/">Distributed System</a>
            </span>
            
            <span>
                <a href="/tags/intro/">Intro</a>
            </span>
            
            <span>
                <a href="/tags/security/">security</a>
            </span>
            
            <span>
                <a href="/tags/web/">web</a>
            </span>
            
        </div>
    </div>
    <div class="sidebar-item sidebar-toc">
        <h3>TOC</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#client">Client</a></li>
  </ul>
</nav></div>
</aside>
        </div>
        <div class="btn">
    <div class="btn-menu" id="btn-menu">
        <i class="iconfont icon-grid-sharp"></i>
    </div>
    <div class="btn-toggle-mode">
        <i class="iconfont icon-contrast-sharp"></i>
    </div>
    <div class="btn-scroll-top">
        <i class="iconfont icon-chevron-up-circle-sharp"></i>
    </div>
</div>
<aside class="sidebar-mobile" style="display: none;">
  <div class="sidebar-wrapper">
    
    <div class="sidebar-item sidebar-pages">
        <h3>Pages</h3>
        <ul>
            
            <li>
                <a href="/">Home</a>
            </li>
            
            <li>
                <a href="/archives/">Archives</a>
            </li>
            
            <li>
                <a href="/about/">About</a>
            </li>
            
            <li>
                <a href="/gpg_email/">Email</a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-links">
        <h3>Links</h3>
        <ul>
            
            <li>
                <a href="https://github.com/lianglouise" target="_blank"><span>GitHub</span></a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/jiasong-liang" target="_blank"><span>Linkedin</span></a>
            </li>
            
        </ul>
    </div>
    
    <div class="sidebar-item sidebar-tags">
        <h3>Tags</h3>
        <div>
            
            <span>
                <a href="/tags/distributed-system/">Distributed System</a>
            </span>
            
            <span>
                <a href="/tags/intro/">Intro</a>
            </span>
            
            <span>
                <a href="/tags/security/">security</a>
            </span>
            
            <span>
                <a href="/tags/web/">web</a>
            </span>
            
        </div>
    </div>
    
    
    
    <div class="sidebar-item sidebar-toc">
        <h3>TOC</h3>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#client">Client</a></li>
  </ul>
</nav>
    </div>
    
    
  </div>
</aside>
    </main>

    <footer>
    <div class="container-lg clearfix">
        <div class="col-12 footer">
            
            <span>&copy; 2020-2021
                <a href="https://lianglouise.github.io/">Roy Liang</a>
                 | <a href="https://github.com/itsme/my_blog">Source code</a> 
                | Powered by <a href="https://github.com/dsrkafuu/hugo-theme-fuji/"
                   target="_blank">Fuji-v2</a> &amp; <a href="https://gohugo.io/"
                                                    target="_blank">Hugo</a> 
            </span>
        </div>
    </div>
</footer>

    
<script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.0/lazysizes.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>



<script defer src="/assets/js/fuji.min.js"></script>


</body>

</html>